@model Movix.Web.Models.CatalogPageVm
@{
	ViewData["Title"] = "Catálogo de Filmes";
	var f = Model.Filter;
	var result = Model.PageResult!;
}

<form id="catalogForm" method="get" action="@Url.Action("Filmes", "Home")" class="mb-4">
	<input type="hidden" name="Page" value="1" />
	<input type="hidden" name="GeneroId" value="@(f.GeneroId?.ToString() ?? "")" />
	<input type="hidden" name="section" value="genres" />

	<div class="busca row">
		<div class="col-12 col-md-8 col-lg-6 mx-auto">
			<div class="input-group">
				<input type="text"
					   name="Q"
					   class="form-control"
					   value="@f.Q"
					   placeholder="Digite o nome do filme..."
					   aria-label="Buscar Filme" />
				<button type="submit" class="btn btn-info d-flex align-items-center justify-content-center">
					<i class="bi bi-search"></i>
				</button>

			</div>
		</div>
	</div>
</form>

<!-- Carrossel principal -->
<div id="carouselExampleSlidesOnly" class="carousel slide carousel-banner" data-bs-ride="carousel">
	<div class="carousel-inner">
		<div class="carousel-item active">
			<img src='/img/Carrosel1.png' class="d-block w-100" alt="Carrosel 1">
		</div>
		<div class="carousel-item">
			<img src='/img/Carrosel2.png' class="d-block w-100" alt="Carrosel 2">
		</div>
		<div class="carousel-item">
			<img src='/img/Carrosel3.jpeg' class="d-block w-100" alt="Carrosel 3">
		</div>
	</div>
</div>

<!-- Catálogo -->
<div class="container mt-5">
	@foreach (var grupo in result.Items.GroupBy(m => m.GeneroId))
	{
		var genero = Model.Generos.FirstOrDefault(g => g.Id == grupo.Key);
		var nomeDoGenero = genero.Nome ?? ("Gênero " + grupo.Key);

		<h2 class="mt-5 border-bottom pb-2 mb-4">@nomeDoGenero</h2>

		<div class="carousel-wrapper">
			<div class="d-flex flex-nowrap overflow-x-auto gap-4 carousel-viewport">
				@foreach (var m in grupo)
				{
					<div class="card card-movie border-0 shadow-sm"
						 style="min-width: 220px; max-width: 220px; cursor: pointer; overflow: hidden; border-radius: 10px;"
						 data-bs-toggle="modal"
						 data-bs-target="#modalDetalhesFilme"
						 data-titulo="@m.Titulo"
						 data-imagem="@(m.ImagemCapaUrl ?? "https://picsum.photos/seed/fallback/400/600")"
						 data-sinopse="@m.Sinopse"
						 data-urltrailer="@m.UrlTrailer"
						 data-genero="@nomeDoGenero"
						 data-classificacao="@(Model.Classificacoes.FirstOrDefault(c => c.Id == m.ClassificacaoId).Nome ?? "")">

						<img class="card-img-top img-fluid"
							 src="@(m.ImagemCapaUrl ?? "https://picsum.photos/seed/fallback/400/600")"
							 alt="@m.Titulo"
							 style="width: 100%; height: 320px; object-fit: cover; transition: transform 0.3s ease;" />

					</div>

				}
			</div>

			<button class="btn btn-carousel-prev" type="button">‹</button>
			<button class="btn btn-carousel-next" type="button">›</button>
		</div>
	}
</div>

<!-- Modal Detalhes -->
<div class="modal fade" id="modalDetalhesFilme" tabindex="-1" aria-labelledby="modalTituloFilme" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="modalTituloFilme">Carregando...</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
			</div>
			<div class="modal-body">
				<div class="row">
					<div class="col-md-5">
						<img id="modalImagemFilme" src="" class="img-fluid rounded" alt="Poster do Filme" />
					</div>
					<div class="col-md-7">
						<p id="modalSinopseFilme"></p>

						<!-- Adicionado: exibir Gênero e Classificação -->
						<p class="mb-1"><strong>Gênero:</strong> <span id="modalGeneroFilme">-</span></p>
						<p class="mb-0"><strong>Classificação:</strong> <span id="modalClassificacaoFilme">-</span></p>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Fechar</button>
				<a id="modalBotaoAssistir" href="#" target="_blank" class="btn btn-outline-success">
					Assistir Agora
				</a>
			</div>
		</div>
	</div>
</div>

<footer class="site-footer mt-5 pt-4 border-top">
	<div class="container">
		<div class="row align-items-center gy-3 text-center text-md-start">

			<div class="col-12 col-md-4">
				<div class="d-flex align-items-center gap-2 justify-content-center justify-content-md-start">
					<span class="logo-mini">M</span>
					<span class="brand-mini">Movix</span>
				</div>
			</div>

			<div class="col-12 col-md-4">
				<h6 class="mb-2">Movix a sua melhor Escolha</h6>
				<ul class="list-unstyled d-flex flex-column flex-md-row justify-content-md-between">
					<li><a href="#home">Home</a></li>
					<li><a asp-controller="Home" asp-action="Planos">Planos</a>
					<li><a asp-controller="Home" asp-action="Filmes">Filmes</a>
					<li><a href="/Auth/Login">Área restrita</a></li>
				</ul>
			</div>

			<div class="col-12 col-md-4 text-md-end">
				<small class="muted">© @DateTime.UtcNow.Year Movix Todos os seus direitos reservados</small>
			</div>
		</div>
	</div>
</footer>


@section Scripts {
	<script>
		document.addEventListener("DOMContentLoaded", function () {

			// =================================================
			// Preenche o modal (mantive tudo igual + genero/classificacao)
			// =================================================
			const movieModal = document.getElementById('modalDetalhesFilme');

			movieModal.addEventListener('show.bs.modal', function (event) {
				const card = event.relatedTarget;
				if (!card) return;

				const titulo = card.getAttribute('data-titulo') ?? '';
				const imagemUrl = card.getAttribute('data-imagem') ?? '';
				const sinopse = card.getAttribute('data-sinopse') ?? '';
				const urlTrailer = card.getAttribute('data-urltrailer') ?? '';

				// novos atributos
				const genero = card.getAttribute('data-genero') ?? '';
				const classificacao = card.getAttribute('data-classificacao') ?? '';

				const modalTitle = movieModal.querySelector('.modal-title');
				const modalImage = movieModal.querySelector('#modalImagemFilme');
				const modalSinopse = movieModal.querySelector('#modalSinopseFilme');

				// elementos novos
				const modalGenero = movieModal.querySelector('#modalGeneroFilme');
				const modalClassificacao = movieModal.querySelector('#modalClassificacaoFilme');

				modalTitle.textContent = titulo;
				modalImage.src = imagemUrl;
				modalSinopse.textContent = sinopse;

				// preenche novos campos (fallback para '-')
				if (modalGenero) modalGenero.textContent = genero && genero.trim() !== '' ? genero : '-';
				if (modalClassificacao) modalClassificacao.textContent = classificacao && classificacao.trim() !== '' ? classificacao : '-';

				const modalBotaoAssistir = movieModal.querySelector('#modalBotaoAssistir');
				modalBotaoAssistir.setAttribute('data-href-temp', urlTrailer);
			});

			movieModal.addEventListener('shown.bs.modal', function () {
				const modalBotaoAssistir = movieModal.querySelector('#modalBotaoAssistir');
				const urlTrailer = modalBotaoAssistir.getAttribute('data-href-temp') ?? '';

				if (urlTrailer && urlTrailer.trim() !== "" && urlTrailer !== "#") {
					modalBotaoAssistir.removeAttribute('disabled');
					modalBotaoAssistir.classList.remove('disabled');
					modalBotaoAssistir.style.pointerEvents = 'auto';
					modalBotaoAssistir.style.opacity = '1';
					modalBotaoAssistir.href = urlTrailer;
					modalBotaoAssistir.setAttribute('target', '_blank');
					modalBotaoAssistir.setAttribute('rel', 'noopener noreferrer');

					modalBotaoAssistir.onclick = function (e) {
						try {
							if (modalBotaoAssistir.href && modalBotaoAssistir.href !== '#' ) {
								window.open(modalBotaoAssistir.href, '_blank', 'noopener');
								return true;
							}
						} catch (err) { }
						return true;
					};
				} else {
					modalBotaoAssistir.href = "#";
					modalBotaoAssistir.classList.add('disabled');
					modalBotaoAssistir.setAttribute('disabled', 'true');
					modalBotaoAssistir.style.pointerEvents = 'none';
					modalBotaoAssistir.style.opacity = '0.6';
					modalBotaoAssistir.onclick = function (e) { e.preventDefault(); return false; };
				}
			});

			movieModal.addEventListener('hidden.bs.modal', function () {
				const modalBotaoAssistir = movieModal.querySelector('#modalBotaoAssistir');
				modalBotaoAssistir.removeAttribute('data-href-temp');
				modalBotaoAssistir.href = '#';
				modalBotaoAssistir.onclick = null;

				// limpa os campos adicionais
				const modalGenero = movieModal.querySelector('#modalGeneroFilme');
				const modalClassificacao = movieModal.querySelector('#modalClassificacaoFilme');
				if (modalGenero) modalGenero.textContent = '';
				if (modalClassificacao) modalClassificacao.textContent = '';
			});

			// =================================================
			// Carrossel: versão robusta por wrapper (funciona para cada gênero)
			// =================================================
			const allCarousels = document.querySelectorAll(".carousel-wrapper");
			allCarousels.forEach(wrapper => {
				const viewport = wrapper.querySelector(".carousel-viewport");
				const btnNext = wrapper.querySelector(".btn-carousel-next");
				const btnPrev = wrapper.querySelector(".btn-carousel-prev");

				if (!viewport || !btnNext || !btnPrev) return;

				// calcula uma quantidade de scroll apropriada baseada na largura do primeiro card
				const getScrollAmount = () => {
					const firstCard = viewport.querySelector('.card-movie') || viewport.querySelector('.card');
					if (firstCard) {
						const gapStyle = getComputedStyle(viewport).gap || getComputedStyle(viewport)['column-gap'] || '16px';
						const gap = parseFloat(gapStyle) || 16;
						const cardWidth = firstCard.getBoundingClientRect().width;
						// tenta rolar pelo número de itens visíveis na viewport (1..n)
						const visibleCount = Math.max(1, Math.floor(viewport.clientWidth / (cardWidth + gap)));
						return Math.round((cardWidth + gap) * visibleCount);
					}
					// fallback
					return Math.round(viewport.clientWidth * 0.8);
				};

				const updateButtonsState = () => {
					// pequeno threshold para evitar problemas de subpixel
					const atStart = viewport.scrollLeft <= 4;
					const atEnd = viewport.scrollLeft + viewport.clientWidth >= viewport.scrollWidth - 4;
					btnPrev.disabled = atStart;
					btnNext.disabled = atEnd;
					btnPrev.classList.toggle('disabled', btnPrev.disabled);
					btnNext.classList.toggle('disabled', btnNext.disabled);
				};

				// handlers
				btnNext.addEventListener("click", function () {
					const amount = getScrollAmount();
					viewport.scrollBy({ left: amount, behavior: 'smooth' });
				});

				btnPrev.addEventListener("click", function () {
					const amount = getScrollAmount();
					viewport.scrollBy({ left: -amount, behavior: 'smooth' });
				});

				// atualiza estado ao rolar/resize
				viewport.addEventListener('scroll', () => {
					// debounced update to avoid too many layout reads
					window.requestAnimationFrame(updateButtonsState);
				});
				window.addEventListener('resize', () => {
					window.requestAnimationFrame(updateButtonsState);
				});

				// inicializa estado
				updateButtonsState();
			});
		});
	</script>
}

<style>
	.busca{
		margin-top: 110px; /* ajuste fino conforme a altura exata da sua navbar */
	}
	.carousel-wrapper {
		position: relative;
	}

	.carousel-viewport {
		scrollbar-width: none;
		-ms-overflow-style: none;
		scroll-behavior: smooth;
		gap: 16px; /* usado por cálculo */
	}

		.carousel-viewport::-webkit-scrollbar {
			display: none;
		}

	.btn-carousel-prev,
	.btn-carousel-next {
		position: absolute;
		top: 50%;
		transform: translateY(-50%);
		z-index: 10;
		background-color: rgba(0, 0, 0, 0.5) !important;
		color: white !important;
		border: none;
		border-radius: 50%;
		width: 45px;
		height: 45px;
		font-size: 1.2rem;
		line-height: 1;
		opacity: 0;
		transition: opacity 0.2s ease;
	}

	.carousel-wrapper:hover .btn-carousel-prev,
	.carousel-wrapper:hover .btn-carousel-next {
		opacity: 1;
	}

	.btn-carousel-prev:hover,
	.btn-carousel-next:hover {
		background-color: rgba(0, 0, 0, 0.8) !important;
		color: white !important;
	}

	.btn-carousel-prev {
		left: 10px;
	}

	.btn-carousel-next {
		right: 10px;
	}

		.btn-carousel-prev[disabled],
		.btn-carousel-next[disabled] {
			opacity: 0.35;
			pointer-events: none;
		}

	.card {
		transition: transform 0.2s ease, box-shadow 0.2s ease;
	}

		.card:hover {
			transform: scale(1.03);
			box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
		}

	.carousel-banner .carousel-item {
		height: 60vh;
	}

		.carousel-banner .carousel-item img {
			height: 100%;
			object-fit: cover;
		}

	.card-movie img:hover {
		transform: scale(1.05);
		filter: brightness(1.1);
	}

	
	.modal-content {
		background: rgba(0, 0, 0, 0.2); /* transparência elegante */
		backdrop-filter: blur(12px); /* efeito vidro desfocado */
		border: 1px solid rgba(255, 255, 255, 0.1);
	}

	.modal-header,
	.modal-body,
	.modal-footer {
		background: transparent !important; /* remove fundo sólido */
		border: none; /* remove linhas indesejadas */
	}
		
		</style>